<div id="pr-auth" class="card">
  <button id="sign-in">Sign in with GitHub</button>
  <div id="whoami" style="display:none">
    <img id="me-avatar" alt="" width="24" height="24" style="border-radius:50%;"> <span id="me-name"></span>
    <button id="sign-out">Sign out</button>
  </div>
</div>

<div id="pr-threads" class="card" aria-live="polite"></div>

<div id="pr-new" class="card" style="margin-top:12px;">
  <textarea id="pr-comment" placeholder="Add a general comment…" rows="3" style="width:100%"></textarea>
  <button id="pr-post">Post to PR</button>
</div>
<div id="pr-root" data-pr='{{ page.pr | default: nil | jsonify }}'></div>

<script>
  (function () {
    const api = "{{ site.api_base }}";
    const owner = "{{ site.repo_owner }}";
    const repo  = "{{ site.repo_name }}";
    const rootEl   = document.getElementById("pr-root");
    const prNumber = JSON.parse(rootEl?.dataset.pr || "null"); // prNumber is number or null

    // Elements
    const btnSignIn = document.getElementById("sign-in");
    const btnSignOut = document.getElementById("sign-out");
    const who = document.getElementById("whoami");
    const avatar = document.getElementById("me-avatar");
    const nameEl = document.getElementById("me-name");
    const threadsRoot = document.getElementById("pr-threads");
    const postBtn = document.getElementById("pr-post");
    const textarea = document.getElementById("pr-comment");

    // Wire handlers FIRST so an earlier error doesn't block clicks
    btnSignIn.onclick = () => { location.href = `${api}/api/auth/login`; };
    btnSignOut.onclick = async () => {
      await fetch(`${api}/api/auth/logout`, { method: "POST", credentials: "include" });
      location.reload();
    };
    postBtn.onclick = async () => {
      const text = textarea.value.trim();
      if (!text) return;
      const r = await fetch(`${api}/api/github/pr-comment`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ owner, repo, prNumber, text })
      });
      if (!r.ok) {
        if (r.status === 401) { alert("Please sign in first."); return; }
        alert("Failed to post comment."); return;
      }
      textarea.value = "";
      await render(); // refresh comments
    };

    function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

    async function safeJson(res) {
      try { return await res.json(); } catch { return null; }
    }

    async function render() {
      // 1) Who am I?
      const meRes = await fetch(`${api}/api/github/me`, { credentials: "include" });
      if (meRes.ok) {
        const me = await meRes.json();
        btnSignIn.style.display = "none";
        who.style.display = "";
        avatar.src = me.avatar_url || "";
        nameEl.textContent = me.name || me.login || "You";
      } else {
        // Not signed in → show sign-in only and stop here (no more API calls)
        who.style.display = "none";
        btnSignIn.style.display = "";
        threadsRoot.innerHTML = `<div class="thread" style="border:none;margin:0;padding:0;color:#777;">
          Sign in to view and post PR comments.
        </div>`;
        return;
      }

      // 2) Load conversations (handle non-200s gracefully)
      const [issueRes, reviewRes] = await Promise.all([
        fetch(`${api}/api/github/pr-comments?owner=${owner}&repo=${repo}&pr=${prNumber}`, { credentials: "include" }),
        fetch(`${api}/api/github/pr-review-comments?owner=${owner}&repo=${repo}&pr=${prNumber}`, { credentials: "include" })
      ]);

      const issueComments = issueRes.ok ? (await safeJson(issueRes) || []) : [];
      const reviewComments = reviewRes.ok ? (await safeJson(reviewRes) || []) : [];

      threadsRoot.innerHTML = "";
      const blocks = [];

      issueComments.forEach(c => {
        blocks.push(
          `<div class="thread">
            <img src="${c.user?.avatar_url||''}" width="20" height="20" style="border-radius:50%;vertical-align:middle">
            <strong>${escapeHtml(c.user?.login)}</strong>
            <span style="color:#777">commented</span>
            <div style="margin-top:6px;">${escapeHtml(c.body)}</div>
          </div>`
        );
      });

      reviewComments.forEach(c => {
        blocks.push(
          `<div class="thread">
            <img src="${c.user?.avatar_url||''}" width="20" height="20" style="border-radius:50%;vertical-align:middle">
            <strong>${escapeHtml(c.user?.login)}</strong>
            <span style="color:#777">on</span> <code>${escapeHtml(c.path)}</code>
            <div style="margin-top:6px;">${escapeHtml(c.body)}</div>
          </div>`
        );
      });

      threadsRoot.innerHTML = blocks.join("") || `<div class="thread" style="border:none;margin:0;padding:0;color:#777;">
        No discussion yet.
      </div>`;
    }

    render();
  })();
</script>


<style>
  .card{border:1px solid var(--border,#e5e7eb); border-radius:12px; padding:12px; background:#fff}
  .thread{border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:10px}
  #pr-new textarea{font:inherit}
</style>
