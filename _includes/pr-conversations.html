<div id="pr-auth" class="card">
  <button id="sign-in">Sign in with GitHub</button>
  <div id="whoami" style="display:none">
    <img id="me-avatar" alt="" width="24" height="24" style="border-radius:50%;"> <span id="me-name"></span>
    <button id="sign-out">Sign out</button>
  </div>
</div>

<div id="pr-threads" class="card" aria-live="polite"></div>

<div id="pr-new" class="card" style="margin-top:12px;">
  <textarea id="pr-comment" placeholder="Add a general commentâ€¦" rows="3" style="width:100%"></textarea>
  <button id="pr-post">Post to PR</button>
</div>

<script>
  (function() {
    const api = "{{ site.api_base }}";
    const owner = "{{ site.repo_owner }}";
    const repo  = "{{ site.repo_name }}";
    const prNumber = "{{ include.pr | default: page.pr | jsonify }}";
    
    async function me() {
      const r = await fetch(`${api}/api/github/me`, { credentials: "include" });
      if (!r.ok) return null;
      return await r.json();
    }

    function gotoLogin() {
      // hit backend login route (sets state cookie and redirects to GitHub)
      location.href = `${api}/api/auth/login`;
    }
    async function logout() {
      await fetch(`${api}/api/auth/logout`, { method: "POST", credentials: "include" });
      location.reload();
    }

    async function load() {
      const user = await me();
      const authDiv = document.getElementById("pr-auth");
      const who = document.getElementById("whoami");
      const si = document.getElementById("sign-in");
      const so = document.getElementById("sign-out");

      if (user) {
        si.style.display = "none";
        who.style.display = "";
        document.getElementById("me-avatar").src = user.avatar_url;
        document.getElementById("me-name").textContent = user.name || user.login;
      } else {
        si.style.display = "";
        who.style.display = "none";
      }

      // Load conversations
      const [issueComments, reviewComments] = await Promise.all([
        fetch(`${api}/api/github/pr-comments?owner=${owner}&repo=${repo}&pr=${prNumber}`, { credentials: "include" }).then(r => r.json()),
        fetch(`${api}/api/github/pr-review-comments?owner=${owner}&repo=${repo}&pr=${prNumber}`, { credentials: "include" }).then(r => r.json()),
      ]);

      const root = document.getElementById("pr-threads");
      root.innerHTML = "";

      function block(html) {
        const d = document.createElement("div");
        d.className = "thread";
        d.innerHTML = html;
        root.appendChild(d);
      }

      issueComments.forEach(c => {
        block(`<div class="cm">
          <img src="${c.user.avatar_url}" width="20" height="20" style="border-radius:50%;vertical-align:middle"> 
          <strong>${c.user.login}</strong> <span style="color:#777">commented</span>
          <div style="margin-top:6px;">${escapeHtml(c.body)}</div>
        </div>`);
      });

      reviewComments.forEach(c => {
        block(`<div class="cm">
          <img src="${c.user.avatar_url}" width="20" height="20" style="border-radius:50%;vertical-align:middle"> 
          <strong>${c.user.login}</strong> on <code>${c.path}</code> <span style="color:#777">at line ${c.line || c.original_line}</span>
          <div style="margin-top:6px;">${escapeHtml(c.body)}</div>
        </div>`);
      });

      document.getElementById("pr-post").onclick = async () => {
        const text = document.getElementById("pr-comment").value.trim();
        if (!text) return;
        const r = await fetch(`${api}/api/github/pr-comment`, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner, repo, prNumber, text })
        });
        if (!r.ok) return alert("Failed to post");
        document.getElementById("pr-comment").value = "";
        load();
      };

      document.getElementById("sign-in").onclick = gotoLogin;
      document.getElementById("sign-out").onclick = logout;
    }

    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

    load();
  })();
</script>

<style>
  .card{border:1px solid var(--border,#e5e7eb); border-radius:12px; padding:12px; background:#fff}
  .thread{border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:10px}
  #pr-new textarea{font:inherit}
</style>
